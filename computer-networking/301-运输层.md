# 运输层

1. 运输层协议为运行在不同主机上的应用进程之间提供了逻辑通信功能。应用进程使用运输层提供的逻辑通信功能彼此发送报文，无需考虑承载这些报文的物理基础。

2. 运输层协议是在端系统中而不是在路由器中实现的。网络路由器仅作用于数据报（segment）的网络层字段。运输层协议只工作在端系统中，它将来自应用程序的报文移动到网络边缘（即网络层），反过来也一样。

3. 网络层提供了主机之间的逻辑通信，而运输层为运行在不同主机上的进程之间提供了逻辑通讯。

4. 因特网（TCP/IP架构）为应用层提供了两种截然不同的可用运输层协议：UDP协议（用户数据报协议）和TCP协议（传输控制协议）。

5. UDP提供一种不可靠的，无连接的服务。
  - 

6. TCP提供一种可靠的，面向连接的服务。能够提供的服务有：
  - 数据的可靠传输
  - 数据的按序传输
  - 流量控制
  - 拥塞控制

7. IP（网际协议）是因特网的一种网络层协议。它为主机之间提供了逻辑通讯，它的服务模型是尽力为交互服务，不确保报文段的交付，不保证报文段的按序交付，不保证报文段的数据完整性。IP是一种不可靠服务。

8. UDP和TCP最基本的责任是，将两个端到端件IP的交付服务扩展为运行在端系统中的两个进程之间的服务。这种将主机间交付扩展到进程间交付的过程称为运输层的多路复用和多路分解。UDP和TCP还可以通过在报文段首部中包括差错检查字段而提供完整性检查。

  进程到进程的数据交付和差错检查是两种最低限度的运输层服务，也是UDP所能提供的仅有的两种服务。UDP也是一种不可靠的服务，不能保证数据完整无缺地传输到目的地。

9. 应用层是直接与套接字（socket）打交道的。没有socket都有唯一标识符，标识符的格式取决于它是UDP还是TCP端口。一台主机的一个端口号，可以对应一个TCP服务和一个UDP服务。端口号是一个16比特的整数，大小在0～65535之间。0～1023之间的端口号称为周知端口号，这些端口号保留给HTTP，FTP这些众所周知的应用层协议来使用。周知端口的列表在`RFC 1700`中给出，同时在`http://www.iana.org`上有更新文档`RFC 3232`。

10. 将运输层报文段中的数据交付给正确的套接字的工作称为多路分解。在源主机从不同的套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传输到网络层，这些工作称为多路复用。

  运输层的报文段中会添加目标端口号和源端口号，当报文段到达主机后，运输层会根据报文段中的目的端口号来将数据定向到对应的端口号。

11. 通常，应用程序的客户端让运输层自动地（并且是透明地）分配端口号，而服务端则要自行指定一个端口号（因为服务的地址必须明确且固定）。

12. 无连接的多路复用与多路分解和有连接的是不同的。

  UDP的套接字是由一个二元组（目的IP地址和目的端口号）来全面标识的。如果两个UDP报文段有不同的源IP地址或源端口号，但具有相同的目的IP地址和目的端口号，那么这两个报文段将通过相同的套接字被定位到相同的进程。

  TCP套接字是由一个四元组（源IP地址，源端口号和目标IP地址，目标端口号）来标识的。当一个报文段从网络到达一台主机时，该主机使用全部四个值来将报文段定向（分解）到相应的端口号。与UDP套接字不同的是，两个具有不同源IP或源端口号的TCP报文段会被定向到两个不同的套接字，除非TCP报文段携带了初始创建创建连接的请求。
  TCP套接字分为两类，连接套接字和数据套接字。连接套接字只用来处理TCP连接请求，它的端口号就是应用的端口号。数据套接字是在连接套接字成功建立连接后生成的，与客户端的某一个套接字进行数据交互。

13. 虽然TCP提供了可靠数据传输服务，而UDP没有提供，但是并不是所有的情况下都应该首选TCP。也有很多应用更适合UDP，原因如下：

  - 关于何时，发送什么数据的应用层控制更加精细。数据只要发送给UDP，UDP就会把数据打包，然后立即发送出去。而TCP有拥堵控制机制，在失败时会进行重试，消息的及时性不太好。

  - 无需连接建立，耗时短，效率高。DNS就是使用的UDP协议。

  - 无连接状态。TCP需要在端系统中维护连接状态。这个连接状态包括接受和发送缓存、拥塞控制参数以及序号和确认号的参数，要维护这些需要耗费端系统的内存和CPU资源，所以UDP相较于TCP能支持更多的活跃用户。

  - 分组首部开销小。每个TCP报文段都有20字节的首部开销，而UDP仅有8字节的开销。

14. 常用应用使用的传输协议如下：

  | 应用           | 应用层协议 | 传输协议  |
  | ---            | ---        | ---       |
  | 电子邮件       | SMTP       | TCP       |
  | 远程终端控制   | Telnet     | TCP       |
  | Web            | HTTP       | TCP       |
  | 文件传输       | FTP        | TCP       |
  | 远程文件服务器 | NFS        | 通常UDP   |
  | 流式多媒体     | 通常专用   | UDP或TCP  |
  | 因特网电话     | 通常专用   | UDP或TCP  |
  | 网络管理       | SNMP       | 　通常UDP |
  | 路由转换协议   | RIP        | 通常UDP   |
  | 名字转换       | DNS        | 通常UDP   |

15. UDP协议由四个字段组成，每个字段为2个字节：源端口号，目的端口号，长度，校验和。长度指示了UDP报文段的字节数（首部加数据）。校验和的计算除了使用UDP报文段之外，还用到了IP首部的一些字段。

  UDP校验和是发送方的UDP为报文段中的所有16比特（不含校验和字段）的和进行反码运算，求和时遇到的任何溢出都被回卷。得到的结果就是校验和。回卷，也就是循环进位求和，就是当相加出现进位的时候，将最高位的进位加到最低位上。反码运算就是将二进制数的各位按位取反。在接收方，将所有数据和校验和相加，出现进位时进行回卷，结果就是0xFFFF，如果有一位bite为0，就说明分组出现了差错。

  虽然许多链路层协议（比如以太网协议）也提供了差错校验，但是传输层也必须进行差错校验。这是因为无法保证源和目的之间所有的链路由提供了差错校验。另外，即使保证了链路中数据的正确性，也无法确保数据存储在某台路由器的时候有没有出现比特差错，所以传输层必须在端到端基础上提供差错检测。这就是在系统设计中被称颂的端到端原则（end-end principle）：与在较高级别提供功能的代价相比，在较低级别上设置的功能可能是冗余的或几乎没价值的。

16. 虽然UDP提供了差错校验，但是它对差错恢复无能为力。UDP的某种实现只是丢弃受损的报文段；其他实现是将受损的报文段交给应用程序并给出警告。

17. 
